{
  "appId": "truecover",
  "id": "locationMap",
  "configType": "geoWidget",
  "profileId": "householdProfile",
  "mapLayers": [
    {
      "layer": "STREET",
      "active": true
    },
    {
      "layer": "SATELLITE",
      "active": false
    },
    {
      "layer": "STREET_SATELLITE",
      "active": false
    }
  ],
  "registrationQuestionnaire": {
    "id": "truecover-add-location",
    "title": "{{ add.household }}",
    "saveButtonText": "{{ save }}",
    "setPractitionerDetails": true,
    "setOrganizationDetails": true,
    "linkIds": [
      {
        "type": "LOCATION",
        "linkId": "select-operational-area"
      }
    ],
    "extraParams": [
      {
        "paramType": "PREPOPULATE",
        "linkId": "positionLongitude",
        "dataType": "STRING",
        "key": "positionLongitude",
        "value": ""
      },
      {
        "paramType": "PREPOPULATE",
        "linkId": "positionLatitude",
        "dataType": "STRING",
        "key": "positionLatitude",
        "value": ""
      }
    ]
  },
  "resourceConfig": {
    "baseResource": {
      "resource": "Location",
      "dataQueries": [
        {
          "paramName": "status",
          "filterCriteria": [
            {
              "dataType": "CODE",
              "value": {
                "code": "active"
              }
            }
          ]
        },
        {
          "paramName": "type",
          "filterCriteria": [
            {
              "dataType": "CODE",
              "value": {
                "system": "http://terminology.hl7.org/CodeSystem/location-physical-type",
                "code": "bu"
              }
            }
          ]
        }
      ]
    },
    "relatedResources": [
      {
        "id": "relatedLists",
        "resource": "List",
        "searchParameter": "subject",
        "isRevInclude": true,
        "relatedResources": [
          {
            "id": "relatedGroups",
            "resource": "Group",
            "searchParameter": "item",
            "isRevInclude": false
          }
        ]
      },
      {
        "id": "relatedTasks",
        "resource": "Task",
        "searchParameter": "subject",
        "isRevInclude": true
      },
      {
        "id": "relatedQuestionnaireResponses",
        "resource": "QuestionnaireResponse",
        "searchParameter": "subject",
        "isRevInclude": true,
        "sortConfigs": [
          {
            "paramName": "_lastUpdated",
            "dataType": "DATE",
            "order": "DESCENDING"
          }
        ]
      }
    ]
  },
  "showAddLocation": true,
  "showPlaneSwitcher": true,
  "showLocation": true,
  "noResults": {
    "title": "{{ no.location.set }}",
    "message": "{{ set.location.to.sync.data.and.load.households}}",
    "actionButton": {
      "id": "noResultsButton",
      "visible": true,
      "display": "{{ set.location.sync }}",
      "actions": [
        {
          "trigger": "ON_CLICK",
          "workflow": "LAUNCH_LOCATION_SELECTOR",
          "display": "{{ set.location.sync }}",
          "multiSelectViewConfig": {
            "resourceConfig": {
              "baseResource": {
                "resource": "Location",
                "dataQueries": [
                  {
                    "paramName": "type",
                    "operation": "OR",
                    "filterCriteria": [
                      {
                        "dataType": "CODE",
                        "value": {
                          "system": "https://smartregister.org/codes/administrative-level",
                          "code": "2"
                        }
                      },
                      {
                        "dataType": "CODE",
                        "value": {
                          "system": "https://smartregister.org/codes/administrative-level",
                          "code": "3"
                        }
                      }
                    ]
                  }
                ]
              }
            },
            "parentIdFhirPathExpression": "Location.partOf.reference",
            "contentFhirPathExpression": "Location.name",
            "rootNodeFhirPathExpression": {
              "key": "Location.type.coding.where(system='https://smartregister.org/codes/administrative-level').code",
              "value": "2"
            },
            "viewActions": [
              "SYNC_DATA"
            ],
            "mutuallyExclusive": false
          }
        }
      ]
    }
  },
  "servicePointConfig": {
    "rules": [
      {
        "name": "familyRegistered",
        "condition": "true",
        "priority": 1,
        "actions": [
          "data.put('familyRegistered', (size(relatedGroups) > 0))"
        ]
      },
      {
        "name": "registerFamily",
        "condition": "true",
        "priority": 1,
        "actions": [
          "data.put('registerFamily', (size(relatedGroups) < 1))"
        ]
      },
      {
        "name": "familyLogicalId",
        "condition": "true",
        "priority": 1,
        "actions": [
          "data.put('familyLogicalId', fhirPath.extractValue(relatedGroups.get(0), \"Group.id\"))"
        ]
      },
      {
        "name": "name",
        "condition": "true",
        "actions": [
          "data.put('name', fhirPath.extractValue(Location, \"Location.name\"))"
        ]
      },
      {
        "name": "locationId",
        "condition": "true",
        "actions": [
          "data.put('locationId', fhirPath.extractValue(Location, \"Location.id\"))"
        ]
      },
      {
        "name": "status",
        "condition": "true",
        "actions": [
          "data.put('status', fhirPath.extractValue(Location, \"Location.status\"))"
        ]
      },
      {
        "name": "positionLongitude",
        "condition": "true",
        "actions": [
          "data.put('positionLongitude', fhirPath.extractValue(Location, \"Location.position.longitude\"))"
        ]
      },
      {
        "name": "positionLatitude",
        "condition": "true",
        "actions": [
          "data.put('positionLatitude', fhirPath.extractValue(Location, \"Location.position.latitude\"))"
        ]
      },
      {
        "name": "type",
        "condition": "true",
        "actions": [
          "data.put('type', fhirPath.extractValue(Location, \"Location.type.where(coding.system = 'http://smartregister.org/CodeSystem/true_cover-point-type').coding.code\") != '' ? fhirPath.extractValue(Location, \"Location.type.where(coding.system = 'http://smartregister.org/CodeSystem/true_cover-point-type').coding.code\") : fhirPath.extractValue(Location, \"Location.type.where(coding.system = 'http://terminology.hl7.org/CodeSystem/location-type').coding.code\"))"
        ]
      },
      {
        "name": "mostRecentHHSurveyQRExists",
        "condition": "true",
        "priority": 1,
        "actions": [
          "data.put('mostRecentHHSurveyQRExists', (size(relatedQuestionnaireResponses) > 0) ? 'true'  : 'false')"
        ]
      },
      {
        "name": "mostRecentHHSurveyQRStatus",
        "condition": "true",
        "priority": 1,
        "actions": [
          "data.put('mostRecentHHSurveyQRStatus', (size(relatedQuestionnaireResponses) > 0) ? fhirPath.extractValue(relatedQuestionnaireResponses.get(0), \"QuestionnaireResponse.item.where(linkId = 'was-survey-done' and answer.count()>0).answer.value.code\")  : '')"
        ]
      },
      {
        "name": "visitStatus",
        "condition": "true",
        "priority": 2,
        "actions": [
          "data.put('visitStatus', data.get('mostRecentHHSurveyQRExists')== 'true' ? ( (data.get('mostRecentHHSurveyQRStatus') == 'yes') ? 'visited' : 'rejected') : 'not_visited')"
        ]
      },
      {
        "name": "typeImage",
        "condition": "true",
        "priority": 3,
        "actions": [
          "data.put('typeImage', data.get('visitStatus') == 'not_visited' ? 'ic_home' : data.get('visitStatus') == 'rejected' ? 'ic_rejected' : data.get('visitStatus') == 'visited' ? 'ic_done' : 'ic_home')"
        ]
      },
      {
        "name": "distanceFromHouseholdFormattedString",
        "condition": "true",
        "priority": 1,
        "actions": [
          "data.put('distanceFromHouseholdFormattedString', locationService.calculateDistanceByGpsLocation(Location))"
        ]
      },
      {
        "name": "distanceFromHouseholdString",
        "condition": "true",
        "priority": 2,
        "actions": [
          "data.put('distanceFromHouseholdString', (data.get('distanceFromHouseholdFormattedString').split(\" \")[0]) )"
        ]
      },
      {
        "name": "distanceFromHouseholdDouble",
        "condition": "true",
        "priority": 3,
        "actions": [
          "data.put('distanceFromHouseholdDouble', (new (\"java.lang.Double\", data.get('distanceFromHouseholdString')))  )"
        ]
      },
      {
        "name": "isNearHousehold",
        "condition": "true",
        "priority": 4,
        "actions": [
          "data.put('isNearHousehold', ( data.get('distanceFromHouseholdDouble')  < 0.5 ) ? true : false )"
        ]
      },
      {
        "name": "viewRegisterFamilyForm",
        "condition": "true",
        "priority": 5,
        "actions": [
          "data.put('viewRegisterFamilyForm', data.get('registerFamily') && data.get('isNearHousehold'))"
        ]
      },
      {
        "name": "viewHouseholdProfile",
        "condition": "true",
        "priority": 5,
        "actions": [
          "data.put('viewHouseholdProfile', data.get('familyRegistered') && data.get('isNearHousehold'))"
        ]
      },
      {
        "name": "showProximityError",
        "condition": "true",
        "priority": 5,
        "actions": [
          "data.put('showProximityError', !data.get('isNearHousehold'))"
        ]
      }

    ],
    "servicePointProperties": {
      "visitStatus": "@{visitStatus}",
      "name": "@{name}",
      "status": "@{status}",
      "familyLogicalId": "@{familyLogicalId}",
      "locationId": "@{locationId}",
      "positionLongitude": "@{positionLongitude}",
      "positionLatitude": "@{positionLatitude}",
      "familyRegistered": "@{familyRegistered}",
      "registerFamily": "@{registerFamily}",
      "typeImage": "@{typeImage}",
      "type": "@{type}",
      "viewRegisterFamilyForm": "@{viewRegisterFamilyForm}",
      "viewHouseholdProfile": "@{viewHouseholdProfile}",
      "showProximityError": "@{showProximityError}"
    }
  },
  "topScreenSection": {
    "title": "{{ households.map }}",
    "searchBar": {
      "visible": true,
      "display": "{{ search.by.location.name  }}",
      "computedRules": [
        "name"
      ]
    },
    "menuIcons": [
      {
        "viewType": "IMAGE",
        "imageConfig": {
          "type": "local",
          "reference": "ic_filter"
        },
        "actions": [
          {
            "trigger": "ON_CLICK",
            "workflow": "LAUNCH_LOCATION_SELECTOR",
            "display": "{{ set.location.filter }}",
            "multiSelectViewConfig": {
              "resourceConfig": {
                "baseResource": {
                  "resource": "Location",
                  "dataQueries": [
                    {
                      "paramName": "type",
                      "operation": "OR",
                      "filterCriteria": [
                        {
                          "dataType": "CODE",
                          "value": {
                            "system": "https://smartregister.org/codes/administrative-level",
                            "code": "2"
                          }
                        },
                        {
                          "dataType": "CODE",
                          "value": {
                            "system": "https://smartregister.org/codes/administrative-level",
                            "code": "3"
                          }
                        }
                      ]
                    }
                  ]
                }
              },
              "parentIdFhirPathExpression": "Location.partOf.reference",
              "contentFhirPathExpression": "Location.name",
              "rootNodeFhirPathExpression": {
                "key": "Location.type.coding.where(system='https://smartregister.org/codes/administrative-level').code",
                "value": "2"
              }
            }
          }
        ]
      },
      {
        "viewType": "IMAGE",
        "imageConfig": {
          "type": "local",
          "reference": "ic_service_points"
        },
        "actions": [
          {
            "trigger": "ON_CLICK",
            "workflow": "LAUNCH_REGISTER",
            "id": "taskRegister"
          }
        ]
      }
    ]
  },
  "actions": [
    {
      "trigger": "ON_CLICK",
      "workflow": "SUMMARY_BOTTOM_SHEET",
      "id": "summaryBottomSheet",
      "display": "{{ household.details }}",
      "params": [
        {
          "paramType": "PARAMDATA",
          "key": "householdId",
          "value": "@{householdId}"
        }
      ]
    }
  ],
  "summaryBottomSheetConfig": {
    "views": [
      {
        "viewType": "CARD",
        "visible": "true",
        "contentPadding": 0,
        "content": [
          {
            "viewType": "CARD",
            "contentPadding": 16,
            "visible": "true",
            "content": [
              {
                "viewType": "ROW",
                "alignment": "START",
                "fillMaxWidth": true,
                "clickable": false,
                "children": [
                  {
                    "viewType": "IMAGE",
                    "tint": "#9e9b9b",
                    "size": 60,
                    "imageConfig": {
                      "type": "local",
                      "reference": "@{typeImage}"
                    },
                    "isCircular": true
                  },
                  {
                    "viewType": "COLUMN",
                    "children": [
                      {
                        "viewType": "COMPOUND_TEXT",
                        "primaryText": "@{name}",
                        "primaryTextFontWeight": "BOLD",
                        "fontSize": 17.0,
                        "primaryTextColor": "#000000"
                      },
                      {
                        "viewType": "SPACER",
                        "height": 8
                      },
                      {
                        "viewType": "BUTTON",
                        "smallSized": true,
                        "text": "Household Profile",
                        "status": "DUE",
                        "alignment": "CENTER",
                        "startIcon": {
                          "type": "local",
                          "reference": "@{ic_home}"
                        },
                        "clickable": "@{familyRegistered}",
                        "visible": "@{viewHouseholdProfile}",
                        "fillMaxWidth": false,
                        "actions": [
                          {
                            "trigger": "ON_CLICK",
                            "workflow": "LAUNCH_PROFILE",
                            "id": "householdProfile",
                            "params": [
                              {
                                "paramType": "RESOURCE_ID",
                                "key": "familyLogicalId",
                                "value": "@{familyLogicalId}"
                              }
                            ]

                          }
                        ]
                      },
                      {
                        "viewType": "SPACER",
                        "height": 8
                      },
                      {
                        "viewType": "BUTTON",
                        "smallSized": true,
                        "text": "Fill Household Survey",
                        "status": "DUE",
                        "alignment": "CENTER",
                        "startIcon": {
                          "type": "local",
                          "reference": "@{ic_home}"
                        },
                        "clickable": "@{registerFamily}",
                        "visible": "@{viewRegisterFamilyForm}",
                        "fillMaxWidth": false,
                        "actions": [
                          {
                            "trigger": "ON_CLICK",
                            "workflow": "LAUNCH_QUESTIONNAIRE",
                            "questionnaire": {
                              "id": "truecover-add-location",
                              "title": "Add Household",
                              "saveButtonText": "Save",
                              "extraParams": [
                                {
                                  "paramType": "PREPOPULATE",
                                  "linkId": "location-id",
                                  "dataType": "STRING",
                                  "key": "locationId",
                                  "value": "@{locationId}"
                                },
                                {
                                  "paramType": "PREPOPULATE",
                                  "linkId": "positionLongitude",
                                  "dataType": "STRING",
                                  "key": "positionLongitude",
                                  "value": "@{positionLongitude}"
                                },
                                {
                                  "paramType": "PREPOPULATE",
                                  "linkId": "positionLatitude",
                                  "dataType": "STRING",
                                  "key": "positionLatitude",
                                  "value": "@{positionLatitude}"
                                }
                              ]
                            }
                          }
                        ]
                      },
                      {
                        "viewType": "SPACER",
                        "height": 8
                      },
                      {
                        "viewType": "COMPOUND_TEXT",
                        "primaryText": "{{ proximity.error }}",
                        "visible": "@{showProximityError}",
                        "primaryTextFontWeight": "SEMI_BOLD",
                        "fontSize": 14.0,
                        "primaryTextColor": "#000000"
                      }
                    ]
                  }
                ]
              }
            ]
          }
        ]
      }
    ]
  },
  "filterDataByRelatedEntityLocation": true,
  "filterDataByLocationLineage": true
}